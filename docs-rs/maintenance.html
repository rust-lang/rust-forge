<!DOCTYPE HTML>
<html lang="en" class="light sidebar-visible" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Maintenance procedures - Rust Forge</title>


        <!-- Custom HTML head -->

        <meta name="description" content="Supplemental documentation for contributing to The Rust Programming Language">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="../favicon.svg">
        <link rel="shortcut icon" href="../favicon.png">
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        <link rel="stylesheet" href="../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" id="highlight-css" href="../highlight.css">
        <link rel="stylesheet" id="tomorrow-night-css" href="../tomorrow-night.css">
        <link rel="stylesheet" id="ayu-highlight-css" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->


        <!-- Provide site root and default themes to javascript -->
        <script>
            const path_to_root = "../";
            const default_light_theme = "light";
            const default_dark_theme = "navy";
        </script>
        <!-- Start loading toc.js asap -->
        <script src="../toc.js"></script>
    </head>
    <body>
    <div id="mdbook-help-container">
        <div id="mdbook-help-popup">
            <h2 class="mdbook-help-title">Keyboard shortcuts</h2>
            <div>
                <p>Press <kbd>←</kbd> or <kbd>→</kbd> to navigate between chapters</p>
                <p>Press <kbd>S</kbd> or <kbd>/</kbd> to search in the book</p>
                <p>Press <kbd>?</kbd> to show this help</p>
                <p>Press <kbd>Esc</kbd> to hide this help</p>
            </div>
        </div>
    </div>
    <div id="body-container">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                let theme = localStorage.getItem('mdbook-theme');
                let sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            const default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? default_dark_theme : default_light_theme;
            let theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            const html = document.documentElement;
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add("js");
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            let sidebar = null;
            const sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            sidebar_toggle.checked = sidebar === 'visible';
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <!-- populated by js -->
            <mdbook-sidebar-scrollbox class="sidebar-scrollbox"></mdbook-sidebar-scrollbox>
            <noscript>
                <iframe class="sidebar-iframe-outer" src="../toc.html"></iframe>
            </noscript>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="default_theme">Auto</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search (`/`)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="/ s" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">Rust Forge</h1>

                    <div class="right-buttons">
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        <a href="https://github.com/rust-lang/rust-forge" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>
                        <a href="https://github.com/rust-lang/rust-forge/edit/master/src/docs-rs/maintenance.md" title="Suggest an edit" aria-label="Suggest an edit">
                            <i id="git-edit-button" class="fa fa-edit"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="common-maintenance-procedures"><a class="header" href="#common-maintenance-procedures">Common maintenance procedures</a></h1>
<h2 id="temporarily-remove-a-crate-from-the-queue"><a class="header" href="#temporarily-remove-a-crate-from-the-queue">Temporarily remove a crate from the queue</a></h2>
<p>It might happen that a crate fails to build repeatedly due to a docs.rs bug,
clogging up the queue and preventing other crates to build. In this case it’s
possible to temporarily remove the crate from the queue until the docs.rs’s bug
is fixed. To do that, log into the machine and open a PostgreSQL shell with:</p>
<pre><code>$ psql
</code></pre>
<p>Then you can run this SQL query to remove the crate:</p>
<pre><code>UPDATE queue SET attempt = 100 WHERE name = '&lt;CRATE_NAME&gt;';
</code></pre>
<p>To add the crate back in the queue you can run in the PostgreSQL shell this
query:</p>
<pre><code>UPDATE queue SET attempt = 0 WHERE name = '&lt;CRATE_NAME&gt;';
</code></pre>
<h2 id="pinning-a-version-of-nightly"><a class="header" href="#pinning-a-version-of-nightly">Pinning a version of nightly</a></h2>
<p>Sometimes the latest nightly might be broken, causing doc builds to fail. In
those cases it’s possible to tell docs.rs to stop updating to the latest
nightly and instead pin a specific release. To do that you need to edit the
<code>/home/cratesfyi/.docs-rs-env</code> file, adding or changing this environment
variable:</p>
<pre><code>CRATESFYI_TOOLCHAIN=nightly-YYYY-MM-DD
</code></pre>
<p>Once the file changed docs.rs needs to be restarted:</p>
<pre><code>systemctl restart docs.rs
</code></pre>
<p>To return to the latest nightly simply remove the environment variable and
restart docs.rs again.</p>
<h2 id="rebuild-a-specific-crate"><a class="header" href="#rebuild-a-specific-crate">Rebuild a specific crate</a></h2>
<p>If a bug was recently fixed, you may want to rebuild a crate so that it builds with the latest version.
From the docs.rs machine:</p>
<pre><code>cratesfyi queue add &lt;crate&gt; &lt;version&gt;
</code></pre>
<p>This will add the crate with a lower priority than new crates by default, you can change the priority with the <code>-p</code> option.</p>
<h2 id="raise-the-limits-for-a-specific-crate"><a class="header" href="#raise-the-limits-for-a-specific-crate">Raise the limits for a specific crate</a></h2>
<p>Occasionally crates will ask for their build limits to be raised.
You can raise them from the docs.rs machine with <code>psql</code>.</p>
<p>Raising a memory limit to 8 GB:</p>
<pre><code class="language-psql"># memory is measured in bytes
cratesfyi=&gt; INSERT INTO sandbox_overrides (crate_name, max_memory_bytes)
  VALUES ('crate name', 8589934592);
</code></pre>
<p>Raising a timeout to 15 minutes:</p>
<pre><code class="language-psql">cratesfyi=&gt; INSERT INTO sandbox_overrides (crate_name, timeout_seconds)
  VALUES ('crate name', 900);
</code></pre>
<p>Raising limits for multiple crates at once:</p>
<pre><code class="language-psql">cratesfyi=&gt; INSERT INTO sandbox_overrides (crate_name, max_memory_bytes)
  VALUES ('stm32f4', 8589934592), ('stm32h7', 8589934592), ('stm32g4', 8589934592);
</code></pre>
<h2 id="set-a-group-of-crates-to-be-automatically-de-prioritized"><a class="header" href="#set-a-group-of-crates-to-be-automatically-de-prioritized">Set a group of crates to be automatically de-prioritized</a></h2>
<p>When many crates from the same project are published at once, they take up a
lot of space in the queue. You can de-prioritize groups of crates at once like
this:</p>
<pre><code class="language-psql">cratesfyi=&gt; INSERT INTO crate_priorities (pattern, priority)
  VALUES ('group-%', 1);
</code></pre>
<p>The <code>pattern</code> should be a <code>LIKE</code> pattern as documented on
<a href="https://www.postgresql.org/docs/current/functions-matching.html">https://www.postgresql.org/docs/current/functions-matching.html</a>.</p>
<p>Note that this only sets the default priority for crates with that name.
If there are crates already in the queue, you’ll have to update those manually:</p>
<pre><code class="language-psql">cratesfyi=&gt; UPDATE queue SET priority = 1 WHERE name LIKE 'group-%';
</code></pre>
<h2 id="adding-all-the-crates-failed-after-a-date-back-in-the-queue"><a class="header" href="#adding-all-the-crates-failed-after-a-date-back-in-the-queue">Adding all the crates failed after a date back in the queue</a></h2>
<p>After an outage you might want to add all the failed builds back to the queue.
To do that, log into the machine and open a PostgreSQL shell with:</p>
<pre><code>psql
</code></pre>
<p>Then you can run this SQL query to add all the crates failed after <code>YYYY-MM-DD HH:MM:SS</code> back in the queue:</p>
<pre><code>UPDATE queue SET attempt = 0 WHERE attempt &gt;= 5 AND build_time &gt; 'YYYY-MM-DD HH:MM:SS';
</code></pre>
<h2 id="removing-a-crate-from-the-website"><a class="header" href="#removing-a-crate-from-the-website">Removing a crate from the website</a></h2>
<p>Sometimes it might be needed to remove all the content related to a crate from
docs.rs (for example after receiving a DMCA). To do that, log into the server
and run:</p>
<pre><code>cratesfyi database delete-crate CRATE_NAME
</code></pre>
<p>The command will remove all the data from the database, and then remove the
files from S3.</p>
<h2 id="blacklisting-crates"><a class="header" href="#blacklisting-crates">Blacklisting crates</a></h2>
<p>Occasionally it might be needed to prevent a crate from being built on docs.rs,
for example if we can’t legally host the content of those crates. To add a
crate to the blacklist, preventing new builds for it, you can run:</p>
<pre><code>cratesfyi database blacklist add &lt;CRATE_NAME&gt;
</code></pre>
<p>Other operations (such as <code>list</code> and <code>remove</code>) are also supported.</p>
<blockquote>
<p><strong>Warning:</strong> blacklisting a crate doesn’t remove existing content from the
website, it just prevents new versions from being built!</p>
</blockquote>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../docs-rs/self-hosting.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="../governance/index.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../docs-rs/self-hosting.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="../governance/index.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="../elasticlunr.min.js"></script>
        <script src="../mark.min.js"></script>
        <script src="../searcher.js"></script>

        <script src="../clipboard.min.js"></script>
        <script src="../highlight.js"></script>
        <script src="../book.js"></script>

        <!-- Custom JS scripts -->
        <script src="../js/moment.min.js"></script>
        <script src="../js/index.js"></script>


    </div>
    </body>
</html>
